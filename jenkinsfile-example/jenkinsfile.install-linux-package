// This Jenkins pipeline script installs required linux packages on amazon linux container for CICD

pipeline {
    agent {
        kubernetes {
            cloud 'Amazon_EKS'
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
spec:
  containers:
  - name: dind
    image: docker:dind
    securityContext:
      privileged: true
    env:
    - name: DOCKER_TLS_CERTDIR
      value: ""
    - name: DOCKER_HOST
      value: "tcp://localhost:2375"
    ports:
    - containerPort: 2375
    volumeMounts:
    - name: dind-storage
      mountPath: /var/lib/docker
  - name: amazonlinux
    image: amazonlinux:2023
    env:
    - name: DOCKER_HOST
      value: "tcp://localhost:2375"
    command:
    - cat
    tty: true
  volumes:
  - name: dind-storage
    emptyDir: {}
'''
        }
    }

    stages {
        stage('Install Dependencies') {
            steps {
                container('amazonlinux') {
                    sh '''
                    # Update and install dependencies
                    dnf update -y
                    dnf install -y docker aws-cli

                    # Wait for Docker daemon
                    echo "Waiting for Docker daemon..."
                    until docker info > /dev/null 2>&1; do
                      sleep 1
                    done
                    echo "Docker daemon is ready"
                    
                    # Install kubectl
                    curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.34.1/2025-09-19/bin/linux/amd64/kubectl                    
                    chmod +x ./kubectl
                    mkdir -p $HOME/bin && cp ./kubectl $HOME/bin/kubectl && export PATH=$HOME/bin:$PATH
                    echo 'export PATH=$HOME/bin:$PATH' >> ~/.bashrc

                    # Verify installations
                    echo "Docker version:"
                    docker --version
                    echo "AWS CLI version:"
                    aws --version
                    echo "Kubectl version:"
                    kubectl version --client
                    '''
                }
            }
        }

        stage('Test Docker') {
            steps {
                container('amazonlinux') {
                    sh '''
                    # Test Docker
                    docker run hello-world
                    '''
                }
            }
        }
    }
}
